<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel='stylesheet' type='text/css' href="{% static "Bootstrap/css/bootstrap.css" %}"  />
    <link rel='stylesheet' type='text/css' href="{% static "Bootstrap/css/bootstrap.min.css"%}"/>
    <link rel='stylesheet' type='text/css' href="{% static "Bootstrap/css/bootstrap.vertical-tabs.css"%}"/>
    <link rel='stylesheet' type='text/css' href="{% static "css/default.css"%}"/>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="{% static "Bootstrap/js/jquery.min.js" %}"></script>
    <script src="{% static "Bootstrap/js/bootstrap.min.js"%}"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type ="text/javascript" src="{%static "js/v.js" %}"></script>
     {% include "navbar.html" %}

  </head>
<body onload="initialize()">
  
    <div class="row">
         <div class="col-xs-6">
         </div>
         <div class="col-xs-2">
            <a href="/addtruck/" role="button" class="btn btn-success btn-large btn-block">ADD TRUCK</a>
         </div> 
          <div class="col-xs-2 show">   
             <button type="button" class="btn btn-primary btn-block one" onclick="showtruck(-1)">SHOW INFO</button>
          </div>
 <div class="col-xs-2 hd">   
 <button type="button" class="btn btn-danger btn-block two" onclick="Hideinfo()">HIDE INFO</button>
 </div>
        
          
    </div>    
<div class="col-xs-3"> <!-- required for floating -->
    <!-- Nav tabs -->

 
    {% for a,b,c,d,e in place%}
       <button type="button" class="btn btn-primary btn-block three" data-toggle="collapse" data-target='#demo{{a.id}}' onclick="showtruck({{ a.id}})">{{a.state}}:{{a.rto}}:{{a.numberone}}:{{a.numbertwo}}</button>
       <div id='demo{{a.id}}' class="collapse ">
         
          <table class="table table-responsive ">
             <tbody>
               <tr class="success">
                 <td>Source:</td>
                 <td>{{b}},{{c}}</td>
               </tr>
               <tr class="danger">
                 <td>Destination:</td>
                 <td>{{d}},{{e}}</td>
               </tr>
             </tbody>
          </table>
          <button type="button" class="btn btn-danger btn-block" onclick="deletetruck()">Deregister your truck</button>
        
      </div>

      
    {% endfor %}    

</div>


<div class="col-xs-9">
     <div class="container" id="map_canvas" style="width:1210px;height:700px;align:center;"></div>
</div>
  
</body>
<script type="text/javascript">

  
  var map;
  var directionDisplay;
  var directionsService;
  var stepDisplay;
 
  var position;
  var marker = [];
  var polyline = [];
  var poly2 = [];
  var poly = null;
  var startLocation = [];
  var endLocation = [];
  var timerHandle = [];
  var currentDistance = [];
    
  
  var speed = 0.00000001, wait = 5;
  var infowindow = null;
  
  var myPano;   
  var panoClient;
  var nextPanoId;
  var i=0;
  var startLoc = new Array();
  var endLoc = new Array();
  var vehicle=new Array();
  var infowindow=new Array();
  {% for a,b,c,d,e in place%}
     startLoc[i]='{{b}},{{c}}'
     endLoc[i]='{{d}},{{e}}'
     vehicle[i]='{{a.state}}:{{a.rto}}:{{a.numberone}}:{{a.numbertwo}}'
     i=i+1
  {% endfor %}


  var Colors = ["#FF0000", "#00FF00", "#0000FF"];


function initialize() {  

  infowindow = new google.maps.InfoWindow(
    { 
      size: new google.maps.Size(150,50)
    });

    var myOptions = {
      center:new google.maps.LatLng(28.613939,77.209021),
      zoom:14,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    
   setRoutes();
  } 


function createMarker(latlng, label, html,icon) {
// alert("createMarker("+latlng+","+label+","+html+","+color+")");
    var contentString = '<b>'+vehicle[label]+'</b><br>'+startLoc[label]+" to "+endLoc[label];
    var marker = new google.maps.Marker({
        position: latlng,
        map: map,
        title: label,
        icon: icon,
        zIndex: Math.round(latlng.lat()*-100000)<<5
        });
        marker.myname = label;


    /*google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent("hello"); 
        
        });*/
       infowindow[label] = new google.maps.InfoWindow({
      content: contentString
  });
    //infowindow[label].open(map,marker);
    return marker;
}  


function setRoutes(){   

    var directionsDisplay = new Array();

    for (var i=0; i< startLoc.length; i++){

    var rendererOptions = {
        map: map,
        suppressMarkers : true,
        preserveViewport: true
    }
    directionsService = new google.maps.DirectionsService();

    var travelMode = google.maps.DirectionsTravelMode.DRIVING;  

    var request = {
        origin: startLoc[i],
        destination: endLoc[i],
        travelMode: travelMode
    };  

        directionsService.route(request,makeRouteCallback(i,directionsDisplay[i]));

    }   


    function makeRouteCallback(routeNum,disp){
        if (polyline[routeNum] && (polyline[routeNum].getMap() != null)) {
         startAnimation(routeNum);
         return;
        }
        return function(response, status){
          
          if (status == google.maps.DirectionsStatus.OK){

            var bounds = new google.maps.LatLngBounds();
            var route = response.routes[0];
            startLocation[routeNum] = new Object();
            endLocation[routeNum] = new Object();


            polyline[routeNum] = new google.maps.Polyline({
            path: [],
            strokeColor: '#FFFF00',
            strokeWeight: 3
            });

            poly2[routeNum] = new google.maps.Polyline({
            path: [],
            strokeColor: '#FFFF00',
            strokeWeight: 3
            });     


            // For each route, display summary information.
            var path = response.routes[0].overview_path;
            var legs = response.routes[0].legs;


            disp = new google.maps.DirectionsRenderer(rendererOptions);     
            disp.setMap(map);
            disp.setDirections(response);


            //Markers               
            for (i=0;i<legs.length;i++) {
              if (i == 0) { 
                startLocation[routeNum].latlng = legs[i].start_location;
                startLocation[routeNum].address = legs[i].start_address;
                // marker = google.maps.Marker({map:map,position: startLocation.latlng});
                marker[routeNum] = createMarker(legs[i].start_location,routeNum,legs[i].start_address,"{% static "img/1.png"%}");
              }
              endLocation[routeNum].latlng = legs[i].end_location;
              endLocation[routeNum].address = legs[i].end_address;
              var steps = legs[i].steps;

              for (j=0;j<steps.length;j++) {
                var nextSegment = steps[j].path;                
                var nextSegment = steps[j].path;

                for (k=0;k<nextSegment.length;k++) {
                    polyline[routeNum].getPath().push(nextSegment[k]);
                    //bounds.extend(nextSegment[k]);
                }

              }
            }

         }       

         polyline[routeNum].setMap(map);
         //map.fitBounds(bounds);
         startAnimation(routeNum);  

    } // else alert("Directions request failed: "+status);

  }

}

    var lastVertex = 1;
    var stepnum=0;
    var step = 3; // 5; // metres
    var tick = 100; // milliseconds
    var eol= [];
//----------------------------------------------------------------------                
 function updatePoly(i,d) {
 // Spawn a new polyline every 20 vertices, because updating a 100-vertex poly is too slow
    if (poly2[i].getPath().getLength() > 20) {
          poly2[i]=new google.maps.Polyline([polyline[i].getPath().getAt(lastVertex-1)]);
          // map.addOverlay(poly2)
        }

    if (polyline[i].GetIndexAtDistance(d) < lastVertex+2) {
        if (poly2[i].getPath().getLength()>1) {
            poly2[i].getPath().removeAt(poly2[i].getPath().getLength()-1)
        }
            poly2[i].getPath().insertAt(poly2[i].getPath().getLength(),polyline[i].GetPointAtDistance(d));
    } else {
        poly2[i].getPath().insertAt(poly2[i].getPath().getLength(),endLocation[i].latlng);
    }
 }
//----------------------------------------------------------------------------

function animate(index,d) {
   if (d>eol[index]) {

      marker[index].setPosition(endLocation[index].latlng);
      marker[index].setOptions({zIndex: Math.round(latlng.lat()*-100000)<<5});
      return;
   }
    var p = polyline[index].GetPointAtDistance(d);

    //map.panTo(p);
    marker[index].setPosition(p);
    marker[index].setOptions({zIndex: Math.round(p.lat()*-100000)<<5});
    updatePoly(index,d);
    timerHandle[index] = setTimeout("animate("+index+","+(d+step)+")", tick);
    currentDistance[index]=d+step;
}

//-------------------------------------------------------------------------

function startAnimation(index) {
        if (timerHandle[index]) clearTimeout(timerHandle[index]);
        eol[index]=polyline[index].Distance();
        map.setCenter(polyline[index].getPath().getAt(0));

        poly2[index] = new google.maps.Polyline({path: [polyline[index].getPath().getAt(0)], strokeColor:"#FFFF00", strokeWeight:3});

        timerHandle[index] = setTimeout("animate("+index+",50)",2000);  // Allow time for the initial map display
        currentDistance[index]=50;
}

//----------------------------------------------------------------------------    
function stopAnimation(index) {
  clearTimeout(timerHandle[index]);
}

function continueAnimation(index) {
    d=currentDistance[index];
    timerHandle[index] = setTimeout("animate("+index+","+d+")", tick);
}
function showtruck(num){
  if(num !=-1){
     num=num-1;
     
     for(x=0;x<marker.length;x++){
        if(x!=num){
         marker[x].setVisible(false);
         infowindow[x].close(map,marker[x]);
        }
        else{
          marker[x].setVisible(true);
         infowindow[x].open(map,marker[x]); 
        }
     }
   }
   else{
      for(x=0;x<marker.length;x++){
      
         marker[x].setVisible(true);
         infowindow[x].open(map,marker[x]);
        
     }
   }
}
function Hideinfo(){
 
     
     for(x=0;x<marker.length;x++){
        
          infowindow[x].close(map,marker[x]);
        }
        
}

function deletetruck(){
  alert("We have received your request.We will get back to you soon");
}

</script>


<script type="text/javascript">
_uacct = "UA-162157-1";
urchinTracker();
</script>

</html>